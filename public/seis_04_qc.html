<!DOCTYPE html>
<html>

<head>
    <title>EDS</title>
    <script src="./lib/w2ui/w2ui-2.0.min.js"></script>
    <link rel="stylesheet" type="text/css" href="./lib/w2ui/w2ui-2.0.min.css">
    <!-- <link rel="stylesheet" type="text/css" href="./lib/bootstrap-icons.min.css"> -->

    <link href="./stylesheets/bootstrap.min.css" rel="stylesheet">
    <link href="./stylesheets/css2.css" rel="stylesheet">
    <link href="./lib/bootstrap-icons.css" rel="stylesheet">
    <script src="./lib/bootstrap.bundle.min.js"></script>
</head>
<style>
    #w2grd_file_selection {
        height: 350px;
        margin: 0px 0px 20px 25px;
        transition: 0.7s ease-out;
    }
    #w2grid_files_for_loading {
        height: 350px;
        margin: 0px 20px 20px 0px;
        transition: 0.7s ease-out;
    }
    
</style>

<body>
    <div style="height: 180px;"></div>
    <div class="container">
        <div class="row">
            <div class="col">
                <div id="w2grid_files_for_loading" style="height: 350px;"></div>
            </div>
        </div>    
        <div class="row">
            <div class="col">
                <div id="w2tab_headers" style="margin-bottom: 20px;"></div>
                <div id="tab1" class="tab-content">
                    First tab.
                </div>
                <div id="tab2" class="tab-content">
                    
                </div>
                <div id="tab3" class="tab-content">                        
                    
                </div>
            </div>
        </div>
    </div>

    <script>
        var g_mode = "file_select";
        const g_apiUrl = '';

        //Check if anything is passed. If not, default to file selection
        
 
        // widget configuration
        let file_load_list = new w2grid({
            name: 'file_load_list',
            box: '#w2grid_files_for_loading',
            show: {
                header: true,
                // footer: true,
                toolbar: true
            },
            toolbar: {
                items: [
                    // { type: 'button', id: 'add_files', text: 'Add files from stage', icon: 'bi bi-plus-circle' },
                    // { type: 'break' },
                    // { type: 'button', id: 'done', text: 'Proceed to load data', icon: 'bi bi-arrow-right-square' },
                ],
                onClick: function (target, data) {
                    change_page_mode("file_select");  
                }
            },
            header: '<b>Files Selected for Loading</>',
            // records: [{
            //     file_name: 'test',
            //     crs: 'test',
            //     survey: "testsrvy",
            //     qc: true
            // }],
            method: 'GET', // need this to avoid 412 error on Safari
            columns: [
                { field: 'file_name', text: 'File Name', size: '40%' },
                { field: 'file_path', text: 'Path', size: '60%' },
                // { field: 'crs', text: 'Spheroid', size: '30%', editable: { type: 'text' } },
                // { field: 'survey', text: 'Survey Name', size: '30%' },
                // { field: 'stage', text: 'Stage', size: '40%' },
                // { field: 'version', text: 'Version', size: '120px' },
                // { field: 'dt', text: 'Depth/Time', size: '120px' },
                // { field: 'qc', text: 'QC <input type="checkbox" id="qc_check_all">', type: 'toggle', size: '60px', editable: { type: 'checkbox' } }
            ]
        })

        let w2tab_headers = new w2tabs({
            box: '#w2tab_headers',
            name: 'tabs',
            active: 'tab1',
            tabs: [
                { id: 'tab1', text: 'EBCDIC Header' },
                { id: 'tab2', text: 'Binary Header' },
                { id: 'tab3', text: 'Trace Headers' }
            ],
            onClick: async function (event) {
                document.querySelectorAll(".tab-content").forEach(x=>x.setAttribute("style","display:none"));
                document.querySelector(`#${event.target}`).setAttribute("style","");

                console.log (event.target);
                switch (event.target) {
                    case "tab1":                        
                        let header_content = await call("ebc-hdr");
                        document.querySelector(`#${event.target}`).innerHTML = header_content;
                        break;
                
                    default:
                        break;
                }
            }
        });

        // Read selected file list from localstorage and add to file listing
        try {
            const g_files = JSON.parse(localStorage.getItem('files'));
            console.log(g_files);
            w2ui.file_load_list.add(g_files);
        } catch (error) {
            
        }
        
        //Wrapper function to make API call to server
        async function call (api_request,target){
            let apiUrl, trace_no = 0, file_type = "3D";
            switch (api_request) {
                case "ebc-hdr":
                case "EBCDIC-header":
                    apiUrl = g_apiUrl + "get_ebc_hdr";
                    break;
                case "bin-hdr":
                case "binary-header":
                    apiUrl = g_apiUrl + "get_bin_hdr";
                    break;
                case "trc-hdr":
                case "trace-header":
                    apiUrl = g_apiUrl + "get_trc_hdr";
                    break;            
                case "qc-log":                
                    apiUrl = g_apiUrl + "qc_log";
                    break;            
                default:
                    break;
            }

            // Get select file with path
            let selectedRecord = w2ui.file_load_list.get(w2ui.file_load_list.getSelection()[0]);
            
            // Prepare POST request with file path and file type
            const formData = new FormData();
            formData.append('file_path', selectedRecord.file_path + "/" + selectedRecord.file_name);
            formData.append('traceno', trace_no);
            // formData.append('file_type', file_type);

            return fetch(apiUrl, {
                method: 'POST',
                body: formData,
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(data);
                return data;
            })
            .catch(error => {
                console.error('Error fetching SEGY data:', error);                
            });
        }

    </script>
</body>

</html>